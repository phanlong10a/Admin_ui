import React, { Component } from "react";
import {
    Grid,
    IconButton,
    Icon,
    TextField,
    Button
} from "@material-ui/core";
import MaterialTable, { MTableToolbar } from 'material-table';
import { sampleReportBySuspectedLevel, exportExcelSampleReportBySuspectedLevel } from "./ReportSampleBySuspectedLevelService";
import { Breadcrumb } from "egret";
import { healthOrganizationSearchByPage } from "../Sample/SampleService";
import { useTranslation, withTranslation, Trans } from 'react-i18next';
import { toast } from "react-toastify";
import VisibilityIcon from '@material-ui/icons/Visibility';
import Autocomplete from "@material-ui/lab/Autocomplete";
import DateFnsUtils from '@date-io/date-fns'
import {
    MuiPickersUtilsProvider,
    KeyboardDatePicker,
} from "@material-ui/pickers";
function MaterialButton(props) {
    const { t, i18n } = useTranslation();
    const item = props.item;
    return <div>
        <IconButton onClick={() => props.onSelect(item, 0)}>
            <Icon color="primary"><VisibilityIcon /></Icon>
        </IconButton>
    </div>;
}

class ReportSampleBySuspectedLevel extends Component {
    state = {
        keyword: '',
        rowsPerPage: 10,
        page: 0,
        labTestList: [],
        item: {},
        totalElements: 0,
    };

    handleTextChange = event => {
        this.setState({ keyword: event.target.value }, function () {
        })
    };

    handleKeyDownEnterSearch = e => {
        if (e.key === 'Enter') {
            this.search();
        }
    };

    setPage = page => {
        this.setState({ page }, function () {
            this.updatePageData();
        })
    };

    setRowsPerPage = event => {
        this.setState({ rowsPerPage: event.target.value, page: 0 }, function () {
            this.updatePageData();
        });
    };

    handleChangePage = (event, newPage) => {
        this.setPage(newPage);
    };

    search() {
        this.setState({ page: 1 }, function () {
            var date = new Date("2000/01/01");
            let { labTest } = this.state;
            var searchObject = {};
            searchObject.text = this.state.keyword;
            searchObject.pageIndex = this.state.page;
            searchObject.pageSize = this.state.rowsPerPage;
            searchObject.fromDate = this.state.fromDate;
            searchObject.toDate = this.state.toDate;
            if (labTest != null) {
                searchObject.labTest = labTest;
            }
            sampleReportBySuspectedLevel(searchObject).then(({ data }) => {
                this.setState({ itemList: [...data] })
            });
        });
    }

    healthOrganizationSearchByPage = () => {
        let obj = { pageIndex: 0, pageSize: 1000000, orgType: 1 };
        healthOrganizationSearchByPage(obj).then(({ data }) => {
            this.setState({ labTestList: data?.content });
        });
    };
    selectHealthOrganization = (labTest) => {
        this.setState({ labTest: labTest }, function () {
            this.search();
        });
    };
    updatePageData = () => {
        var date = new Date("2000/01/01");
        var searchObject = {};
        let { labTest } = this.state;
        searchObject.text = this.state.keyword;
        searchObject.pageIndex = this.state.page;
        searchObject.pageSize = this.state.rowsPerPage;
        searchObject.fromDate = this.state.fromDate;
        searchObject.toDate = this.state.toDate;
        if (labTest != null) {
            searchObject.labTest = labTest;
        }
        sampleReportBySuspectedLevel(searchObject).then(({ data }) => {
            console.log(data)
            this.setState({ itemList: [...data] })
        });
    };
    handleDateChange = (event, source)=>{
        if(source === "toDate" || source === "fromDate"){
            if(source === "fromDate" && event != null){
                event.setHours("00");
                event.setMinutes("00");
                event.setSeconds("00");
            }
            if (source === "toDate" && event != null) {
                event.setHours("23");
                event.setMinutes("59");
                event.setSeconds("00");
            }
            this.setState({[source]: event},()=>{
                this.search()
            })
        }
    }
    componentDidMount() {
        this.updatePageData();
        this.healthOrganizationSearchByPage();
    }

    exportExcel = () => {
        var date = new Date("2000/01/01");
        var searchObject = {};
        let { labTest } = this.state;
        searchObject.text = this.state.keyword;
        searchObject.pageIndex = this.state.page;
        searchObject.pageSize = this.state.rowsPerPage;
        searchObject.fromDate = this.state.fromDate;
        searchObject.toDate = this.state.toDate;
        if (labTest != null) {
            searchObject.labTest = labTest;
        }
    
        exportExcelSampleReportBySuspectedLevel(searchObject).then((result) => {
            const url = window.URL.createObjectURL(
                new Blob([result.data], {
                    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                })
                );
                const link = document.createElement("a");
                link.href = url;
                link.setAttribute("download", "Báo Cáo Tổng Hợp Mẫu Theo Cấp Độ Nghi Nghiễm.xlsx");
                document.body.appendChild(link);
                link.click();
            }) .catch((err) => {
                alert('Đã có lỗi')
            });
    }

    render() {
        const { t, i18n } = this.props;
        let {
            keyword,
            itemList,
            labTestList
        } = this.state;

        let columns = [
            { title: t("Mã mức độ nghi nghiễm"), field: "suspectedLeveCode", align: "left", width: "150" },
            { title: t("Tên mức độ nghi nghiễm"), field: "suspectedLeveName", align: "left", width: "150" },
            // { title: t("Số lượng mẫu đang chờ"), field: "unfinishedQuantity", align: "left", width: "150" },
            { title: t("Số lượng mẫu chưa chuyển"), field: "totalDraft", align: "left", width: "150" },
            { title: t("Số lượng mẫu chờ xác nhận"), field: "totalPending", align: "left", width: "150" },
            { title: t("Số lượng mẫu được xác nhận"), field: "totalAccepted", align: "left", width: "150" },
            { title: t("Tổng số mẫu"), field: "completedQuantity", align: "left", width: "150" }

        ];

        return (
            <div className="m-sm-30">

                <div className="mb-sm-30">
                    <Breadcrumb routeSegments={[{ name: t('report.title') }, { name: t('reportSampleBySuspectedLevel.title') }]} />
                </div>

                <Grid container spacing={3}>
                    <Grid item xs={12} container spacing={2}>
                        <Grid item md={3} sm={4} xs={12}>
                            <Autocomplete
                                options={labTestList}
                                getOptionLabel={(option) => option.name}
                                id="debug"
                                onChange={(event, value) => {
                                    this.selectHealthOrganization(value);
                                }}
                                renderInput={(params) => (
                                    <TextField {...params} label="Tìm kiếm đơn vị xét nghiệm" />
                                )}
                            />
                        </Grid>
                        <Grid item md={2} sm={6} xs={12}>
                            <MuiPickersUtilsProvider utils={DateFnsUtils}>
                                <KeyboardDatePicker
                                    size="small"
                                    className="w-100"
                                    margin="none"
                                    id="date-picker-dialog"
                                    label={
                                        <span>
                                            <span style={{ color: "red" }}></span>
                                            {t("Từ ngày")}
                                        </span>
                                    }
                                    inputVariant="standard"
                                    type="text"
                                    autoOk={true}
                                    format="dd/MM/yyyy"
                                    value={this.state.fromDate ? this.state.fromDate : null}
                                    onChange={(value)  => this.handleDateChange(value, "fromDate")}
                                    KeyboardButtonProps={{
                                        'aria-label': 'change date',
                                    }}
                                />
                            </MuiPickersUtilsProvider>
                        </Grid>
                        <Grid item md={2} sm={6} xs={12}>
                            <MuiPickersUtilsProvider utils={DateFnsUtils}>
                                <KeyboardDatePicker
                                    size="small"
                                    className="w-100"
                                    margin="none"
                                    id="date-picker-dialog"
                                    label={
                                        <span>
                                            <span style={{ color: "red" }}></span>
                                            {t("Đến ngày")}
                                        </span>
                                    }
                                    inputVariant="standard"
                                    type="text"
                                    autoOk={true}
                                    format="dd/MM/yyyy"
                                    value={this.state.toDate ? this.state.toDate : null}
                                    onChange={(value)  => this.handleDateChange(value, "toDate")}
                                    KeyboardButtonProps={{
                                        'aria-label': 'change date',
                                    }}

                                />
                            </MuiPickersUtilsProvider>
                        </Grid>
                        <Grid>
                            <Button 
                                className="mt-10 ml-8"
                                variant="contained"
                                color="primary"
                                onClick={this.exportExcel}
                            >
                                Xuất Excel
                            </Button>
                        </Grid>
                    </Grid>
                    <Grid item xs={12}>
                        <MaterialTable
                            title={t('Danh sách Yếu Tố Dịch Tễ')}
                            data={itemList}
                            columns={columns}
                            parentChildData={(row, rows) => rows.find(a => a.id === row.parentId)}
                            parentChildData={(row, rows) => {
                                var list = rows.find(a => a.id === row.parentId);
                                return list;
                            }}
                            options={{
                                selection: false,
                                actionsColumnIndex: -1,
                                paging: false,
                                search: false,
                                padding: 'dense',
                                toolbar: false
                            }}
                            components={{
                                Toolbar: props => (
                                    <MTableToolbar {...props} />
                                ),
                            }}
                            onSelectionChange={(rows) => {
                                this.data = rows;
                                // this.setState({selectedItems:rows});
                            }}
                            localization={{
                                body: {
                                    emptyDataSourceMessage: `${t(
                                        "general.emptyDataMessageTable"
                                    )}`,
                                },
                            }}
                        />
                        {/* <TablePagination
                            align="left"
                            className="px-16"
                            rowsPerPageOptions={[1, 2, 5, 10, 25, 50, 100]}
                            component="div"
                            labelRowsPerPage={t('general.rows_per_page')}
                            labelDisplayedRows={({ from, to, count }) => `${from}-${to} ${t('general.of')} ${count !== -1 ? count : `more than ${to}`}`}
                            count={this.state.totalElements}
                            rowsPerPage={this.state.rowsPerPage}
                            page={this.state.page}
                            backIconButtonProps={{
                                "aria-label": "Previous Page"
                            }}
                            nextIconButtonProps={{
                                "aria-label": "Next Page"
                            }}
                            onChangePage={this.handleChangePage}
                            onChangeRowsPerPage={this.setRowsPerPage}
                            /> */}
                    </Grid>
                </Grid>
            </div>
        );
    }
}
export default ReportSampleBySuspectedLevel;